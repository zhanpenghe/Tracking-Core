
<!doctype html>
<html style="width:100%; height:100%;">
<head><script src="jquery-2.2.0.min.js"></script>
<title>IoT Eye Bluetooth Visualization</title>
</head>
<body style="width:100%; height:100%; background:#000; color:#0F0; margin:0px;">
<div id="date"></div>
<canvas id="canvas01" style="margin-left:20px; margin-right:20px;margin-top:20px;"></canvas>
<script type="text/javascript">

var img = new Image;
img.src='test_floor.png';
var pos = [];
var index_by_id = [];
var idx_color = ['#34FF85', '#3ABBFF', '#57397F','#34FF85', '#3ABBFF', '#57397F','#FFA214','#F934FF'];
sx = 0.73;
sy = 0.73;
init();

function init() {
  load_positions(true);
  setInterval(load_positions,3);
}

function autoscale() {
    var maxx, maxy;
    maxx= 0;
    maxy=0;

    for(var i = 0; i < pos[0].reader.length; i++) {
        if(pos[0].reader[i].loc) {
            var cx = pos[0].reader[i].loc[0];
            var cy = pos[0].reader[i].loc[1];
            if(cy > maxy) { maxy = cy; }
            if(cx > maxx) { maxx = cx; }
        }
    }

    //sx = 2200/maxx;
    //sy = 1100/maxy;
}

function redraw() {
    var canvas = document.getElementById('canvas01');
    var wheight = window.innerHeight;
    var wwidth = window.innerWidth;
    sx = wwidth/2200;
    sy = wheight/1100;
    var ratio_canvas = 0;
    if(sx > sy){
        sx = sy;
    } else {
        sy = sx;
    }
    if(sx>0.73){
        sx=0.73;
        sy=0.73;
    }

    canvas.height=1100*sy;
    canvas.width=2200*sx;
    var ctx = canvas.getContext('2d');
    ctx.canvas.height=1100*sy;
    ctx.canvas.width=2200*sx;
    ctx.clearRect(0,0,2200*sx,1100*sy);
    ctx.drawImage(img,0,0,2200*sx,1100*sy);
    drawNames(ctx, pos[0], '#00FF00');
    //drawEdges(ctx, pos[0]);
}

function drawNames(ctx, data, color) {
    for(var i = 0; i < data.tag.length; i++) {
        var tag = data.tag[i];

        if(!tag.loc)
            continue;

        if(tag.loc == [0,0])
            continue;

        if(document.getElementById('cb_'+i.toString()).checked){
            ctx.beginPath();
            ctx.fillStyle=idx_color[i];
            ctx.arc(((tag.loc[0]-7) * sx), ((tag.loc[1]-7) * sy),14*sx,0*Math.PI,2*Math.PI);
            ctx.closePath();
            ctx.fill();
            ctx.fillText(tag.id, ((tag.loc[0]+20) * sx), ((tag.loc[1]+20) * sy));
            index_by_id[data.id] = i;
        }
        else{
            continue;
        }


    }

    for(var i = 0; i < data.reader.length; i++) {
        var reader = data.reader[i];

        if(!reader.loc)
            continue;

        ctx.fillStyle='#000000';
        ctx.fillRect(((reader.loc[0]-5) * sx), ((reader.loc[1]-5) * sy),10*sx,10*sx);
        ctx.closePath();

        ctx.fillText(reader.id, ((reader.loc[0]+15) * sx), ((reader.loc[1]+15) * sy));
        index_by_id[data.id] = i;
    }
}

function load_positions(initial) {
    $.getJSON("1.json", function(data){
        if (data) {
            pos[0] = data;
            redraw();
        }
    });
}

</script>
<form>
<input type="checkbox" id="cb_0" checked/> Beacon 1<br>
<input type="checkbox" id="cb_1" checked/> Beacon 2<br>
<input type="checkbox" id="cb_2" checked/> Beacon 3<br>
<input type="checkbox" id="cb_3" checked/> Beacon 4<br>
<input type="checkbox" id="cb_4" checked/> Beacon 5<br>
<input type="checkbox" id="cb_5" checked/> Beacon 6<br>
</form>

</body>
</html>
