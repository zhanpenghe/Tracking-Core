
<!doctype html>
<html style="width:100%; height:100%;">
<head><script src="jquery-2.2.0.min.js"></script>
<title>IoT Eye Bluetooth Visualization</title>
</head>
<body style="width:100%; height:100%; background:#000; color:#0F0;">
<div id="date"></div>
<canvas style="display:block;width:1200px;height:800px;background:#000; margin-left:auto; margin-right: auto;"></canvas>
<script type="text/javascript">

var img = new Image;
img.src='http://192.168.1.14:8000/test_floor.png';
var pos = [];
var index_by_id = [];
sx = 1;
sy = 1;
init();
function init() {
  load_positions(true);
  setInterval(load_positions,3);
}

function autoscale() {
var maxx, maxy;
maxx= 0;
maxy=0;

for(var i = 0; i < pos[0].reader.length; i++) {
  if(pos[0].reader[i].loc)
  {
    var cx = pos[0].reader[i].loc[0];
    var cy = pos[0].reader[i].loc[1];
    if(cy > maxy) { maxy = cy; }
    if(cx > maxx) { maxx = cx; }
  }
}

sx = 1200/maxx;
sy = 800/maxy;
}

function redraw() {
if(sx == sy == 1) {
  //autoscale();
}

var canvas = document.getElementsByTagName('canvas')[0];
canvas.height=800;
canvas.width=1200;
var ctx = canvas.getContext('2d');
ctx.clearRect(0,0,1200,800);
ctx.drawImage(img,0,0,1200,800);
drawNames(ctx, pos[9], '#001000'); 
drawNames(ctx, pos[8], '#002000'); 
drawNames(ctx, pos[7], '#003000'); 
drawNames(ctx, pos[6], '#004000'); 
drawNames(ctx, pos[5], '#005500'); 
drawNames(ctx, pos[4], '#006800'); 
drawNames(ctx, pos[3], '#008800'); 
drawNames(ctx, pos[2], '#00AA00'); 
drawNames(ctx, pos[1], '#00CC00'); 
drawNames(ctx, pos[0], '#00FF00'); 
drawEdges(ctx, pos[0]);
}

function drawNames(ctx, data, color) {
	for(var i = 0; i < data.tag.length; i++) {
	  var tag = data.tag[i];

	  if(!tag.loc)
	    continue;

	  ctx.fillStyle=color;
	  ctx.arc((tag.loc[0] * sx), (tag.loc[1] * sy),5,0*Math.PI,2*Math.PI);
		ctx.closePath();
		ctx.fill();

	  ctx.fillText(tag.id, (tag.loc[0] * sx+5), (tag.loc[1] * sy+10));
	  index_by_id[data.id] = i;
	}

	for(var i = 0; i < data.reader.length; i++) {
	  var reader = data.reader[i];

	  if(!reader.loc)
	    continue;

	  ctx.fillStyle='#0000FF';
	  ctx.fillRect((reader.loc[0] * sx), (reader.loc[1] * sy),10,10);
		ctx.closePath();

	  ctx.fillText(reader.id, (reader.loc[0] * sx+15), (reader.loc[1] * sy+15));
	  index_by_id[data.id] = i;
	}
		
}

function load_positions(initial) {
   $.getJSON("http://192.168.1.14:8000/1.json",
      function(data){
        if (data) {
          for(var i = 10; i > 0; i--) {
            pos[i] = pos[i-1];
          }
          pos[0] = data;
          if(initial) {
            pos[1] = pos[2] = pos[3] = pos[4] = pos[5] = pos[6] = pos[7] = data;
            pos[8] = pos[9] = pos[10] = data;
          }
           redraw();
        }
      });   
}

</script>

</body>
</html>

